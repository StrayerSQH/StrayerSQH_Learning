# 算数表达式求值
## 实验目的和要求
### 实验基本要求
1.采用算符优先级算法，能正确求表达式的值; <br>
2.熟练掌握栈的应用; <br>
3.熟练掌握计算机系统的基本操作方法，了解如何编辑、编译、链接和运行一个C++程序; <br>
4.上机调试程序，掌握查错、排错使程序能正确运行<br>
### 实验扩展：
1.多位数字 2.浮点数输入 3.支持单目运算符 4.多重、多种括号括号匹配 5.连续运算符检测 6.表达式合法性判断 7.非数字输入检测 8.科学计算

## 实验环境
12th Gen Intel(R) Core(TM) i7-1260P   2.10 GHz<br>
Visual Studio 2022 Debug x64 本地Windows调试器

## 算法描述
本程序采用堆栈的方式实现了四则混合运算计算器的功能，具体实现方式如下：<br>
进入程序，输入表达式。<br>
完成表达式输入后，在main.cpp中的bool isRight(string s)函数中，借助堆栈的方式首先对输入的表达式进行括号匹配运算。若匹配则进入Calculator::expRun()函数中进行相关运算，反之则输出错误并要求用户重新输入表达式。<br>
在Calculator类中，初始化私有成员NumStack和OpeStack堆栈，随后调用构造函数Calculator()或 Calculator(string exp)。接下来调用‎Calculator::expRun()函数进行四则混合运算以及错误情况判断。<br>
Calculator::expRun()函数中，确保NumStack堆栈遵循“ANANA…”规则——A代表除括号以外的运算符，N代表char类型的数字，以便区分运算符与数字之间的位置关系。确保OpeStack堆栈遵循“不用则存，用则取”的规则，确保运算符在正确时机出栈参与运算。进行四则混合运算时，遵循“优先级高或相同级的立即进行运算”的原则，先定义‎Calculator::opeGrade()运算符等级函数并根据运算符返回对应等级，随后判断优先级后决定是否立即进行运算。若前一运算符opeBefore等级小于当前运算符opeCh等级，则opeBefore入栈，更新opeBefore=opeCh。若前一运算符opeBefore等级大于等于当前运算符opeCh等级，NumStack堆栈中出两个N，完成运算后放入NumStack，更新运算符。在while(opeGrade(opeCh) <= opeGrade(opeBefore) && !(opeBefore == '=' && opeBefore == opeCh) && !(opeBefore == '(' && opeCh == ')'))循环中重复这一步，直至若前一运算符opeBefore等级小于当前运算符opeCh等级或其他情况。<br>
注意，因为本程序的设计思路在调用Calculator::expRun()函数前已经完成了括号匹配操作。所以遇到opeBefore == ‘(‘ && opeCh == ‘)’时直接将括号配对删除即可。<br>
对于在四则运算外额外实现的功能，针对自然对数e，监测到表达式expressioon[i] == ‘e’后将e的近似值2.718281828459045压入NumStack中作为替代。针对三角函数，借助字符串匹配提取的方式提出三角函数括号中的表达式，并将其定义为一个string b，例如在sin(1+9)中b提取为0+1+9=，在sin(9)中b提取为0+9=，随后将b作为输入嵌套调用Calculator<char> CalTri(b);进行运算，返回运算结果后借助#include <cmath>中的sin()等函数计算出对应数值后立即压入NumStack中作为一个数。<br>
至于错误检测，本程序采用的策略是“变读取变错误判断”，借助表达式expression[i]，expression[i+1]和expression[i-1]之间的关系进行综合判断。如果有错误立即终止运算并标记处错误位置，随后返回<br>


## 实验运行情况分析
一、程序运行情况分析<br>
本程序采用的算法运行出的结果在输入正确的表达式时能够正确完成运算，在输入错误表达式时能够准确指出相关错误在哪里以及错误原因，在输入意义不明表达式时若能进行默认处理则进行正常运算，反之则指出相关错误在哪里以及错误原因。<br>
不过本程序也有相关不足，例如在求解三角函数时无法进行例如sin(sin(9))这样的嵌套类型的三角函数运算或在使用tan()时无法精确判断π/2，仅能输出一很大的正数或很小的负数；在计算-1+1=这种运算时无法根据人类书写与阅读习惯直接计算，程序会输出错误，必须要以(-1)+1=这样的输入才能运算。 <br>
二、运行环境讨论<br>
本程序的编写、编译、运行和调试皆是借助Visual Studio 2022 Debug x64 本地Windows调试器。若将本程序使用DEV C++等软件上编译、运行和调试时可能报错，而这是因为各软件对于支持的C++版本不同所导致的。例如在Visual Studio 2022中可以使用nullptr，而在部分DEV C++中仅能使用NULL。<br>
本程序因为采取的写作思路与事例程序有一定差别，因此代码长度显著长于事例代码。借助Visual Studio 2022 Debug x64 本地Windows调试器强大的功能能够快速编译运行，而在部分DEV C++上则速度较慢。表明程序仍有一定优化空间。<br>
三、个人心得<br>
    在课上听老师讲述运算过程时以为自己听明白了，可是实际上手时发现问题很多。最开始时我想根据事例代码进行简单调整后就完成本次实验，不过发现事例代码存在一定的问题并且设计思路是直接开始进行运算，若有错误直接终止但不具体表明错误位置和错误原因，于是我打算自己从零完成这样一个程序。<br>
在最开始编写程序时，我首先确定了设计思路：先判断括号匹配再进行运算。随后，我开始考虑1+2=和1+2*3+1=这样的简单四则混合运算。不过由于最开始采用的设计思路问题，在运算1+2*3+1=时输出的结果始终是7，这是因为我没有添加如现在代码所示的‎Calculator::expRun()中的while (opeGrade(opeCh) <= opeGrade(opeBefore) && !(opeBefore == '=' && opeBefore == opeCh) && !(opeBefore == '(' && opeCh == ')'))循环，即没办法回头运算表达式最开头的1+。添加上while循环后，我开始考虑括号情况。从1+(2*3+1)=一步步到1+(2-(3*4+5)-10)/2+3=这样复杂的，多重括号进行嵌套的情况。能够解决四则运算后，开始对可能的错误输入的情况进行检测和输出，最后再加上关于自然对数e和三角函数sin，cos，tan和cot的运算。<br>
整体而言自己编写这样一个程序是富有挑战性的，一共花了大概三个下午和晚上进行编写、调试。不过最终的结果是非常符合人的期待的。<br>
四、其他<br>
在编写完成程序后，邀请了同学们帮忙测试程序。期间也发现了许多Bug，后面都逐一进行了相关修正。

